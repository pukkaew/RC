<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó - QC Photo Share</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            padding-bottom: 80px;
        }
        
        /* Header */
        .header {
            background: #00B900;
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .header .info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00B900;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Chat List */
        .chat-list {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .chat-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chat-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 5px;
        }
        
        .chat-item:last-child {
            margin-bottom: 0;
        }
        
        .chat-item:hover {
            background: #f5f5f5;
        }
        
        .chat-item:active {
            transform: scale(0.98);
            background: #e0e0e0;
        }
        
        .chat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .chat-icon.personal {
            background: #4CAF50;
            color: white;
        }
        
        .chat-icon.group {
            background: #2196F3;
            color: white;
        }
        
        .chat-icon.official {
            background: #FF9800;
            color: white;
        }
        
        .chat-info {
            flex: 1;
            min-width: 0;
        }
        
        .chat-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-desc {
            font-size: 12px;
            color: #999;
        }
        
        .chat-arrow {
            color: #ccc;
            font-size: 20px;
            margin-left: 10px;
        }
        
        /* Selected State */
        .chat-item.selected {
            background: #E8F5E9;
            border: 2px solid #00B900;
        }
        
        /* Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 15px;
            display: flex;
            gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: #00B900;
            color: white;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Error State */
        .error {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 10px;
            color: #FF0000;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Preview Section */
        .preview-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .preview-item {
            position: relative;
            padding-bottom: 100%;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .preview-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-more {
            background: rgba(0,0,0,0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 2000;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üì§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå</h1>
        <div class="info" id="headerInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
    
    <!-- Content -->
    <div id="content">
        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó...</div>
        </div>
        
        <!-- Preview Section -->
        <div class="preview-section" id="previewSection" style="display: none;">
            <div class="chat-section-title">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏ä‡∏£‡πå</div>
            <div class="preview-grid" id="previewGrid"></div>
        </div>
        
        <!-- Chat List -->
        <div class="chat-list" id="chatList" style="display: none;">
            <!-- Personal Chat -->
            <div class="chat-section">
                <div class="chat-section-title">‡πÅ‡∏ä‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
                <div class="chat-item" onclick="selectChat('personal')" data-chat-id="personal">
                    <div class="chat-icon personal">üë§</div>
                    <div class="chat-info">
                        <div class="chat-name">‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</div>
                        <div class="chat-desc">Bot ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì</div>
                    </div>
                    <div class="chat-arrow">‚Ä∫</div>
                </div>
            </div>
            
            <!-- Groups -->
            <div class="chat-section" id="groupSection" style="display: none;">
                <div class="chat-section-title">‡∏Å‡∏•‡∏∏‡πà‡∏°</div>
                <div id="groupList"></div>
            </div>
            
            <!-- Official Accounts -->
            <div class="chat-section">
                <div class="chat-section-title">‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏∑‡πà‡∏ô</div>
                <div class="chat-item" onclick="shareViaForward()">
                    <div class="chat-icon official">‚ÜóÔ∏è</div>
                    <div class="chat-info">
                        <div class="chat-name">Forward ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
                        <div class="chat-desc">‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß Forward ‡πÑ‡∏õ‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô</div>
                    </div>
                    <div class="chat-arrow">‚Ä∫</div>
                </div>
                <div class="chat-item" onclick="shareViaLink()">
                    <div class="chat-icon official">üîó</div>
                    <div class="chat-info">
                        <div class="chat-name">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ä‡∏£‡πå</div>
                        <div class="chat-desc">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô</div>
                    </div>
                    <div class="chat-arrow">‚Ä∫</div>
                </div>
            </div>
        </div>
        
        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üì≠</div>
            <h2>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó</h2>
            <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ</p>
        </div>
        
        <!-- Error State -->
        <div class="error" id="error" style="display: none;">
            <div class="error-icon">‚ùå</div>
            <h2>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
            <p id="errorMessage">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
        </div>
    </div>
    
    <!-- Bottom Bar -->
    <div class="bottom-bar" id="bottomBar" style="display: none;">
        <button class="btn btn-secondary" onclick="goBack()">
            <span>üîô</span>
            <span>‡∏Å‡∏•‡∏±‡∏ö</span>
        </button>
        <button class="btn btn-primary" id="shareBtn" disabled onclick="confirmShare()">
            <span>üì§</span>
            <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó</span>
        </button>
    </div>
    
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // Global variables
        let selectedChatId = null;
        let selectedChatType = null;
        let selectedChatName = null;
        let lotNumber = '';
        let imageDate = '';
        let selectedImageIds = [];
        let userId = null;
        let isProcessing = false;
        
        // Initialize LIFF and load data
        async function initialize() {
            try {
                console.log('Initializing chat selector...');
                
                // Get parameters from URL
                const params = new URLSearchParams(window.location.search);
                lotNumber = params.get('lot') || '';
                imageDate = params.get('date') || '';
                const imageIdsParam = params.get('imageIds') || '';
                selectedImageIds = imageIdsParam ? imageIdsParam.split(',') : [];
                
                console.log('Parameters:', { lotNumber, imageDate, selectedImageIds });
                
                if (!lotNumber || !imageDate) {
                    showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Lot ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
                    return;
                }
                
                // Update header
                const formattedDate = new Date(imageDate).toLocaleDateString('th-TH');
                document.getElementById('headerInfo').textContent = 
                    `üì¶ Lot: ${lotNumber} | üìÖ ${formattedDate} | üñºÔ∏è ${selectedImageIds.length || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'} ‡∏£‡∏π‡∏õ`;
                
                // Initialize LIFF
                await initializeLiff();
                
                // Load preview
                loadPreview();
                
                // Load chat list
                await loadChatList();
                
            } catch (error) {
                console.error('Initialization failed:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: ' + error.message);
            }
        }
        
        // Initialize LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2007575196-NWaXrZVE' });
                console.log('LIFF initialized successfully');
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                // Get user profile
                const profile = await liff.getProfile();
                userId = profile.userId;
                console.log('User ID:', userId);
                
            } catch (error) {
                console.error('LIFF initialization failed:', error);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF ‡πÑ‡∏î‡πâ');
                throw error;
            }
        }
        
        // Load preview images
        function loadPreview() {
            const previewGrid = document.getElementById('previewGrid');
            previewGrid.innerHTML = '';
            
            const maxPreview = 8;
            const imageCount = selectedImageIds.length || 10; // Mock count if all images
            
            for (let i = 0; i < Math.min(maxPreview, imageCount); i++) {
                const item = document.createElement('div');
                item.className = 'preview-item';
                
                if (i === maxPreview - 1 && imageCount > maxPreview) {
                    item.classList.add('preview-more');
                    item.innerHTML = `+${imageCount - maxPreview + 1}`;
                } else {
                    // Placeholder for now
                    item.innerHTML = '<div style="background: #e0e0e0; width: 100%; height: 100%;"></div>';
                }
                
                previewGrid.appendChild(item);
            }
            
            document.getElementById('previewSection').style.display = 'block';
        }
        
        // Load chat list
        async function loadChatList() {
            try {
                // Hide loading, show chat list
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chatList').style.display = 'block';
                document.getElementById('bottomBar').style.display = 'flex';
                
                // Try to get user's groups (this is limited by LINE API)
                // For now, we'll use mock data or basic options
                loadMockGroups();
                
            } catch (error) {
                console.error('Error loading chat list:', error);
                showEmptyState();
            }
        }
        
        // Load mock groups for demo
        function loadMockGroups() {
            const mockGroups = [
                { id: 'group1', name: '‡∏ó‡∏µ‡∏° QC', type: 'group' },
                { id: 'group2', name: 'Production Team', type: 'group' },
                { id: 'group3', name: '‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï', type: 'group' }
            ];
            
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = '';
            
            mockGroups.forEach(group => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.setAttribute('data-chat-id', group.id);
                chatItem.setAttribute('data-chat-type', group.type);
                chatItem.setAttribute('data-chat-name', group.name);
                chatItem.onclick = () => selectChat(group.id, group.type, group.name);
                
                chatItem.innerHTML = `
                    <div class="chat-icon group">üë•</div>
                    <div class="chat-info">
                        <div class="chat-name">${group.name}</div>
                        <div class="chat-desc">‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ</div>
                    </div>
                    <div class="chat-arrow">‚Ä∫</div>
                `;
                
                groupList.appendChild(chatItem);
            });
            
            document.getElementById('groupSection').style.display = 'block';
        }
        
        // Select a chat
        function selectChat(chatId, chatType = 'personal', chatName = '‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á') {
            // Remove previous selection
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            const selectedItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // Update selection
            selectedChatId = chatId;
            selectedChatType = chatType;
            selectedChatName = chatName;
            
            // Update button
            const shareBtn = document.getElementById('shareBtn');
            shareBtn.disabled = false;
            shareBtn.innerHTML = `<span>üì§</span><span>‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${chatName}</span>`;
            
            console.log('Selected chat:', { chatId, chatType, chatName });
        }
        
        // Share via forward method
        async function shareViaForward() {
            if (isProcessing) return;
            isProcessing = true;
            
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì...');
                
                // Call API to send images to user
                const response = await fetch('/api/bot-share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        lotNumber: lotNumber,
                        imageDate: imageDate,
                        imageIds: selectedImageIds.length > 0 ? selectedImageIds : null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${result.count} ‡∏£‡∏π‡∏õ ‡πÅ‡∏•‡πâ‡∏ß\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠ Forward`);
                    
                    // Close LIFF after 2 seconds
                    setTimeout(() => {
                        if (liff.isInClient()) {
                            liff.closeWindow();
                        }
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Failed to send images');
                }
                
            } catch (error) {
                console.error('Error sharing via forward:', error);
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                isProcessing = false;
            }
        }
        
        // Share via link
        async function shareViaLink() {
            try {
                // Navigate to share link page
                const params = new URLSearchParams({
                    lot: lotNumber,
                    date: imageDate,
                    imageIds: selectedImageIds.join(',')
                });
                
                window.location.href = `/liff/share.html?${params.toString()}`;
                
            } catch (error) {
                console.error('Error sharing via link:', error);
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
            }
        }
        
        // Confirm share to selected chat
        async function confirmShare() {
            if (!selectedChatId || isProcessing) return;
            isProcessing = true;
            
            try {
                const shareBtn = document.getElementById('shareBtn');
                shareBtn.disabled = true;
                shareBtn.innerHTML = '<span>‚è≥</span><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...</span>';
                
                if (selectedChatId === 'personal') {
                    // Send to personal chat
                    await shareViaForward();
                } else {
                    // For group chats, we need to use a different approach
                    // Since we can't directly send to groups, we'll create a shareable message
                    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå...');
                    
                    // Create shareable flex message
                    const response = await fetch('/api/direct-share/create-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            lotNumber: lotNumber,
                            imageDate: imageDate,
                            imageIds: selectedImageIds.length > 0 ? selectedImageIds : null
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && liff.isApiAvailable('shareTargetPicker')) {
                        // Use LINE's share target picker
                        await liff.shareTargetPicker([result.message]);
                        
                        showToast('‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                        
                        setTimeout(() => {
                            if (liff.isInClient()) {
                                liff.closeWindow();
                            }
                        }, 1500);
                    } else {
                        throw new Error('Share target picker not available');
                    }
                }
                
            } catch (error) {
                console.error('Error confirming share:', error);
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                
                const shareBtn = document.getElementById('shareBtn');
                shareBtn.disabled = false;
                shareBtn.innerHTML = `<span>üì§</span><span>‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${selectedChatName}</span>`;
                isProcessing = false;
            }
        }
        
        // Go back
        function goBack() {
            window.history.back();
        }
        
        // Show error
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('chatList').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        // Show empty state
        function showEmptyState() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('chatList').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }
        
        // Show toast
        function showToast(message, duration = 3000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, duration);
        }
        
        // Initialize on load
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QC Photo Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            padding-bottom: 60px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Header */
        .header {
            background: #00B900;
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .header .info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Auth Section */
        .auth-section {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .auth-status {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .auth-status.success {
            color: #00B900;
        }
        
        .auth-status.error {
            color: #FF0000;
        }
        
        .auth-btn {
            background: #00B900;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .auth-btn:hover {
            background: #00A000;
        }
        
        .auth-btn:active {
            transform: scale(0.95);
        }
        
        .auth-btn.logout {
            background: #666;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00B900;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Debug Info */
        .debug-info {
            background: #f0f0f0;
            margin: 15px;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
        
        /* Toggle Debug Button */
        .debug-toggle {
            position: fixed;
            bottom: 70px;
            right: 15px;
            background: #333;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            z-index: 100;
        }
        
        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            padding: 3px;
        }
        
        @media (min-width: 768px) {
            .image-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                padding: 15px;
                max-width: 1200px;
                margin: 0 auto;
            }
        }
        
        .image-item {
            position: relative;
            padding-bottom: 100%;
            background: #e0e0e0;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease-out;
        }
        
        .image-item:active {
            transform: scale(0.95);
        }
        
        .image-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-item.selected {
            transform: scale(0.9);
        }
        
        .image-item.selected::after {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 5px;
            background: #00B900;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1;
        }
        
        /* Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: #00B900;
            color: white;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-danger {
            background: #FF0000;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }
        
        /* Error State */
        .error {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .error-details {
            background: #f0f0f0;
            padding: 15px;
            margin: 20px auto;
            border-radius: 8px;
            font-size: 12px;
            text-align: left;
            max-width: 90%;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 2000;
            animation: slideUp 0.3s ease-out;
            white-space: pre-line;
            text-align: center;
            max-width: 80%;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        /* No Auth Mode Notice */
        .no-auth-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            text-align: center;
            font-size: 12px;
        }
        
        /* Modal for image viewer */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        
        .modal.show {
            opacity: 1;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-badge.loading {
            background: #cce5ff;
            color: #004085;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QC</h1>
        <div class="info" id="headerInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
    
    <!-- Auth Section -->
    <div class="auth-section" id="authSection">
        <div class="auth-status" id="authStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...</div>
        <button class="auth-btn" id="authBtn" onclick="handleAuth()" style="display: none;">Login with LINE</button>
    </div>
    
    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebug()">üêõ Debug</button>
    
    <!-- Debug Info -->
    <div class="debug-info" id="debugInfo"></div>
    
    <!-- Content -->
    <div id="content" style="display: none;">
        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...</div>
        </div>
        
        <!-- Image Grid -->
        <div class="image-grid" id="imageGrid" style="display: none;"></div>
        
        <!-- Error State -->
        <div class="error" id="error" style="display: none;">
            <div class="error-icon">‚ùå</div>
            <h2>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
            <p id="errorMessage">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</p>
            <div class="error-details" id="errorDetails" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Bottom Bar -->
    <div class="bottom-bar" id="bottomBar" style="display: none;">
        <button class="btn btn-secondary" id="selectBtn" onclick="toggleSelectMode()">
            <span>üìå</span>
            <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span>
        </button>
        <button class="btn btn-primary" id="shareBtn" onclick="shareImages()">
            <span>üì§</span>
            <span>‡πÅ‡∏ä‡∏£‡πå</span>
        </button>
    </div>
    
    <!-- Include LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script>
        // Global variables
        let images = [];
        let selectedImages = new Set();
        let selectMode = false;
        let lotNumber = '';
        let imageDate = '';
        let baseUrl = '';
        let liffInitialized = false;
        let userProfile = null;
        let debugMode = false;
        let authMode = 'checking'; // checking, authenticated, guest
        
        // Debug logging
        function debug(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage, data || '');
            
            // Update debug panel
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                const currentLog = debugInfo.textContent;
                const newLog = data ? `${logMessage}\n${JSON.stringify(data, null, 2)}` : logMessage;
                debugInfo.textContent = currentLog + '\n' + newLog;
                
                // Keep only last 50 lines
                const lines = debugInfo.textContent.split('\n');
                if (lines.length > 50) {
                    debugInfo.textContent = lines.slice(-50).join('\n');
                }
            }
        }
        
        // Toggle debug panel
        function toggleDebug() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.classList.toggle('show', debugMode);
        }
        
        // Clear all LIFF data and force re-authentication
        async function clearLiffData() {
            debug('Clearing LIFF data...');
            
            try {
                // Clear localStorage
                if (typeof localStorage !== 'undefined') {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.includes('liff') || key.includes('line'))) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                        debug(`Removed localStorage: ${key}`);
                    });
                }
                
                // Clear sessionStorage
                if (typeof sessionStorage !== 'undefined') {
                    sessionStorage.clear();
                    debug('Cleared sessionStorage');
                }
                
                // Clear cookies (limited capability)
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                debug('Cleared cookies');
                
            } catch (error) {
                debug('Error clearing data:', error.message);
            }
        }
        
        // Initialize LIFF with better error handling
        async function initializeLiff() {
            debug('Starting LIFF initialization...');
            
            try {
                // Check if LIFF SDK is loaded
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK not loaded');
                }
                
                // Initialize LIFF
                await liff.init({ 
                    liffId: '2007575196-NWaXrZVE',
                    withLoginOnExternalBrowser: true // Allow login on external browsers
                });
                
                liffInitialized = true;
                debug('LIFF initialized successfully', {
                    isInClient: liff.isInClient(),
                    isLoggedIn: liff.isLoggedIn(),
                    os: liff.getOS(),
                    language: liff.getLanguage()
                });
                
                // Check login status
                if (liff.isLoggedIn()) {
                    debug('User is logged in');
                    
                    try {
                        // Get user profile
                        userProfile = await liff.getProfile();
                        debug('User profile retrieved:', {
                            userId: userProfile.userId,
                            displayName: userProfile.displayName
                        });
                        
                        authMode = 'authenticated';
                        updateAuthUI();
                        
                        // Proceed to load images
                        await loadContent();
                        
                    } catch (profileError) {
                        debug('Error getting profile:', profileError.message);
                        
                        // If can't get profile, try to logout and login again
                        if (profileError.message.includes('401') || profileError.message.includes('403')) {
                            debug('Authentication error, forcing re-login...');
                            await handleLogout();
                            await handleLogin();
                        } else {
                            // Use guest mode
                            authMode = 'guest';
                            updateAuthUI();
                            await loadContent();
                        }
                    }
                } else {
                    debug('User is not logged in');
                    authMode = 'guest';
                    updateAuthUI();
                    
                    // Auto-login if in LINE app
                    if (liff.isInClient()) {
                        debug('In LINE app, attempting auto-login...');
                        await handleLogin();
                    }
                }
                
            } catch (error) {
                debug('LIFF initialization error:', error.message);
                liffInitialized = false;
                authMode = 'guest';
                updateAuthUI();
                
                // Try to load content anyway
                await loadContent();
            }
        }
        
        // Update auth UI based on current state
        function updateAuthUI() {
            const authStatus = document.getElementById('authStatus');
            const authBtn = document.getElementById('authBtn');
            const authSection = document.getElementById('authSection');
            
            switch (authMode) {
                case 'checking':
                    authStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...';
                    authStatus.className = 'auth-status';
                    authBtn.style.display = 'none';
                    break;
                    
                case 'authenticated':
                    authStatus.innerHTML = `
                        <span>‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
                        <span class="status-badge success">${userProfile?.displayName || 'User'}</span>
                    `;
                    authStatus.className = 'auth-status success';
                    authBtn.textContent = 'Logout';
                    authBtn.className = 'auth-btn logout';
                    authBtn.style.display = 'inline-block';
                    
                    // Hide auth section after 3 seconds
                    setTimeout(() => {
                        authSection.style.display = 'none';
                    }, 3000);
                    break;
                    
                case 'guest':
                    authStatus.innerHTML = `
                        <span>üë§ ‡πÇ‡∏´‡∏°‡∏î Guest</span>
                        <span class="status-badge loading">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                    `;
                    authStatus.className = 'auth-status';
                    authBtn.textContent = 'Login with LINE';
                    authBtn.className = 'auth-btn';
                    authBtn.style.display = liffInitialized ? 'inline-block' : 'none';
                    break;
            }
        }
        
        // Handle authentication button click
        async function handleAuth() {
            if (authMode === 'authenticated') {
                await handleLogout();
            } else {
                await handleLogin();
            }
        }
        
        // Handle login
        async function handleLogin() {
            debug('Starting login process...');
            
            try {
                if (!liffInitialized) {
                    showToast('‚ùå LIFF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                    return;
                }
                
                // Clear old data first
                await clearLiffData();
                
                // Start login
                liff.login({
                    redirectUri: window.location.href
                });
                
            } catch (error) {
                debug('Login error:', error.message);
                showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ');
            }
        }
        
        // Handle logout
        async function handleLogout() {
            debug('Starting logout process...');
            
            try {
                if (liffInitialized && liff.isLoggedIn()) {
                    // Clear data first
                    await clearLiffData();
                    
                    // Logout from LIFF
                    liff.logout();
                    
                    // Reload page
                    window.location.reload();
                } else {
                    // Just reload if not logged in
                    window.location.reload();
                }
                
            } catch (error) {
                debug('Logout error:', error.message);
                // Force reload anyway
                window.location.reload();
            }
        }
        
        // Load content (images)
        async function loadContent() {
            try {
                // Extract parameters
                const params = new URLSearchParams(window.location.search);
                lotNumber = params.get('lot') || '';
                imageDate = params.get('date') || '';
                baseUrl = window.location.origin;
                
                debug('Parameters:', { lotNumber, imageDate, baseUrl });
                
                if (!lotNumber || !imageDate) {
                    showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Lot ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL');
                    return;
                }
                
                // Show content area
                document.getElementById('content').style.display = 'block';
                
                // Load images
                await loadImages();
                
            } catch (error) {
                debug('Error loading content:', error.message);
                showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', error.message);
            }
        }
        
        // Load images from API
        async function loadImages() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                const apiUrl = `${baseUrl}/api/images/${encodeURIComponent(lotNumber)}/${encodeURIComponent(imageDate)}`;
                debug('Loading images from:', apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                debug('API Response:', {
                    success: data.success,
                    count: data.images?.length || 0
                });
                
                images = data.images || [];
                
                if (images.length === 0) {
                    showError(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û\n\nLot: ${lotNumber}\nDate: ${imageDate}`);
                    return;
                }
                
                updateHeader();
                renderImages();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('imageGrid').style.display = 'grid';
                document.getElementById('bottomBar').style.display = 'flex';
                
            } catch (error) {
                debug('Error loading images:', error.message);
                showError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û\n\n${error.message}`);
            }
        }
        
        // Update header
        function updateHeader() {
            const formattedDate = new Date(imageDate).toLocaleDateString('th-TH');
            document.getElementById('headerInfo').textContent = 
                `üì¶ Lot: ${lotNumber} | üìÖ ${formattedDate} | üñºÔ∏è ${images.length} ‡∏£‡∏π‡∏õ`;
        }
        
        // Render images
        function renderImages() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';
            
            images.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'image-item';
                if (selectedImages.has(index)) {
                    item.classList.add('selected');
                }
                
                const img = document.createElement('img');
                img.src = image.url;
                img.alt = `Image ${index + 1}`;
                img.loading = 'lazy';
                
                item.appendChild(img);
                
                item.onclick = () => {
                    if (selectMode) {
                        toggleImageSelection(index);
                    } else {
                        viewImage(index);
                    }
                };
                
                grid.appendChild(item);
            });
        }
        
        // Toggle select mode
        function toggleSelectMode() {
            selectMode = !selectMode;
            selectedImages.clear();
            
            const selectBtn = document.getElementById('selectBtn');
            const shareBtn = document.getElementById('shareBtn');
            const grid = document.getElementById('imageGrid');
            
            if (selectMode) {
                grid.classList.add('select-mode');
                selectBtn.innerHTML = '<span>‚ùå</span><span>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
                selectBtn.classList.remove('btn-secondary');
                selectBtn.classList.add('btn-danger');
                shareBtn.innerHTML = '<span>üì§</span><span>‡πÅ‡∏ä‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>';
                shareBtn.disabled = true;
                showToast('‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå');
            } else {
                grid.classList.remove('select-mode');
                selectBtn.innerHTML = '<span>üìå</span><span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</span>';
                selectBtn.classList.remove('btn-danger');
                selectBtn.classList.add('btn-secondary');
                shareBtn.innerHTML = '<span>üì§</span><span>‡πÅ‡∏ä‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>';
                shareBtn.disabled = false;
                renderImages();
            }
        }
        
        // Toggle image selection
        function toggleImageSelection(index) {
            if (selectedImages.has(index)) {
                selectedImages.delete(index);
            } else {
                selectedImages.add(index);
            }
            
            const items = document.querySelectorAll('.image-item');
            items[index].classList.toggle('selected');
            
            const shareBtn = document.getElementById('shareBtn');
            if (selectedImages.size > 0) {
                shareBtn.disabled = false;
                shareBtn.innerHTML = `<span>üì§</span><span>‡πÅ‡∏ä‡∏£‡πå ${selectedImages.size} ‡∏£‡∏π‡∏õ</span>`;
            } else {
                shareBtn.disabled = true;
                shareBtn.innerHTML = '<span>üì§</span><span>‡πÅ‡∏ä‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>';
            }
        }
        
        // View single image
        function viewImage(index) {
            // Simple implementation - open in new window
            window.open(images[index].url, '_blank');
        }
        
        // Share images
        async function shareImages() {
            try {
                let imagesToShare = [];
                
                if (selectMode && selectedImages.size > 0) {
                    imagesToShare = Array.from(selectedImages).map(index => images[index]);
                } else {
                    imagesToShare = images;
                }
                
                debug('Sharing images:', imagesToShare.length);
                
                // If authenticated, can use advanced sharing
                if (authMode === 'authenticated' && liffInitialized) {
                    // Use LIFF share
                    if (liff.isApiAvailable('shareTargetPicker')) {
                        const messages = [{
                            type: 'text',
                            text: `üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QC\nüì¶ Lot: ${lotNumber}\nüìÖ ${new Date(imageDate).toLocaleDateString('th-TH')}\nüñºÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${imagesToShare.length} ‡∏£‡∏π‡∏õ\n\nüîó ${window.location.href}`
                        }];
                        
                        const result = await liff.shareTargetPicker(messages);
                        if (result) {
                            showToast('‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                        }
                    } else {
                        copyShareLink();
                    }
                } else {
                    // Guest mode - just copy link
                    copyShareLink();
                }
                
            } catch (error) {
                debug('Share error:', error.message);
                showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå');
            }
        }
        
        // Copy share link
        function copyShareLink() {
            const shareText = `üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QC\nüì¶ Lot: ${lotNumber}\nüìÖ ${new Date(imageDate).toLocaleDateString('th-TH')}\nüñºÔ∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${images.length} ‡∏£‡∏π‡∏õ\n\nüîó ${window.location.href}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß');
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = shareText;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß');
            }
        }
        
        // Show error
        function showError(message, details = null) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('errorMessage').innerHTML = message.replace(/\n/g, '<br>');
            
            if (details) {
                const detailsEl = document.getElementById('errorDetails');
                detailsEl.style.display = 'block';
                detailsEl.textContent = typeof details === 'string' ? details : JSON.stringify(details, null, 2);
            }
        }
        
        // Show toast
        function showToast(message, duration = 3000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, duration);
        }
        
        // Initialize on load
        window.addEventListener('load', async () => {
            debug('Page loaded, starting initialization...');
            
            // Check URL parameters first
            const params = new URLSearchParams(window.location.search);
            
            // Check for OAuth error
            if (params.get('error') || params.get('error_description')) {
                debug('OAuth error detected:', {
                    error: params.get('error'),
                    description: params.get('error_description')
                });
                
                // Clear error parameters and reload
                const cleanUrl = window.location.origin + window.location.pathname;
                const cleanParams = new URLSearchParams();
                if (params.get('lot')) cleanParams.set('lot', params.get('lot'));
                if (params.get('date')) cleanParams.set('date', params.get('date'));
                
                window.location.replace(`${cleanUrl}?${cleanParams.toString()}`);
                return;
            }
            
            // Initialize LIFF
            await initializeLiff();
        });
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                debug('Page became visible');
                // You can refresh data here if needed
            }
        });
        
        // Handle online/offline
        window.addEventListener('online', () => {
            debug('Network: online');
            showToast('‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß');
        });
        
        window.addEventListener('offline', () => {
            debug('Network: offline');
            showToast('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
        });
    </script>
</body>
</html>